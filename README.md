# phylostan: phylogenetic inference using Stan

## Introduction

## Features
Phylogenetic model components:
- Nucleotide substitution mode: JC69, HKY, GTR
- Rate heterogeneity: discretized Weibull distribution and general discrete distribution
- Time tree:
  - Homochronous sequences: same sampling date
  - Heterochronous sequences: sequences sampled a different time points
 - Molecular clock:
   - Strict
   - Autocorrelated
   - Uncorrelated: log-normal hierachical prior
 - Coalescent model:
   - Constant population size
   - Skyride
   - Skygrid 

Algorithms provided by Stan:
- Variational inference:
  - Mean-field distribution
  - Full-rank distribution
- No U-Turn Sampler (NUTS)
- Hamiltonian Monte Carlo (HMC)

## Prerequisites

You will need to install python, pystan, numpy, cython, dendropy.

## You can install phylostan using pip
```bash
pip install phylostan
```

## You can also run it locally
```bash
python -m phylostan.phylostan
```

##Command-line usage

*phylostan* is decomposed into two sub-commands:
- *build*: creates a Stan file: a text file containing the model.
- *run*: runs a Stan file with the data.

These two steps are separated so the user can edit the Stan model. The main reason would be to modify the priors.

To get some help about the *build* or *run* commands:
```bash
phylostan build --help
phylostan run --help
```

## Quickstart

We are going to use the `fluA.fa` alignment and `fluA.tree` tree files. This dataset contains 69 influenza A virus haemagglutinin nucleotide sequences isolated between 1981 and 1998.  

First, a Stan script needs to be generated using the *build* command:
```bash
phylostan build -s fluA-GTR-W4.stan -m HKY -C 4 --heterochronous --estimate_rate --clock strict --coalescent constant
```

This command is going to create a Stan file `fluA-GTR-W4.stan` with the following model:
- Hasegawa, Kishino and Yano (HKY) nucleotide substitution model
- Rate heterogeneity with 4 rate categories using the Weibull distribution
- Assumes that sequences were sampled are different time points (heterochronous)
- Constant effective population
- The subsitution rate will be estimated

In the second step we compile and run the script with our data
```bash
cd examples/fluA
phylostan run -m GTR -i fluA.fa -t fluA.tree -o fluA -s fluA-GTR-W4.stan -m GTR -C 4 --heterochronous --estimate_rate --clock strict --coalescent constant -q meanfield
```

The *run* command requires the data (tree and alignment) and an output parameter.
It also needs the parameters that were provided to the *build* command.
The output will consists of 4 files:
- `fluA`: this file is the output file of Stan. It contains the samples drawn from the variational distribution (or MCMC samples).
- `fluA.diag`: this file is also generated by Stan and it contains some information such as the ELBO at each iteration.
- `fluA.trees`: this file is a nexus tree file that can be opened with a program such as FigTree.
- `fluA-GTR-W4.pkl`: the Stan script is compiled into this binary file. This file can be reused automatically by *phylostan* unless it must be recompiled, then the option `--compile` can be used.

At the end of the run, phylostan will print the mean and 95% credibility interval of the parameters of interest:
```
Weibull (shape) mean: 0.488 95% CI: (0.383,0.616)
Strict clock (rate) mean: 0.00499 95% CI: (0.00432,0.00577)
Constant population size (theta) mean: 4.03 95% CI: (3.14,5.05)
HKY (kappa) mean: 5.58 95% CI: (4.37 7.039)
Root height mean: 18.96 95% CI: (18.36 19.74)
```
In this example we have used a mean-field distribution (`-q meanfield`) to approximate the posterior.
The Stan model is already compiled so we can run the NUTS algorithm without re-generating the script file, simply issue the command:
```bash
phylostan run -m GTR -i fluA.fa -t fluA.tree -o fluA -s fluA-GTR-W4.stan -m GTR -C 4 --heterochronous --estimate_rate --clock strict --coalescent constant -a nuts
```

The NUTS algorithm is much slower (and more accurate) than variational inference so it should be used on a small dataset. 